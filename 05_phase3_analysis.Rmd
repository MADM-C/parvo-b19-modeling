---
title: "Phase 3 Analyses"
author: "Matthew Kaufmann"
date: '`r Sys.Date()`'
output: html_document
code_folding: hide
---
```{r, echo = FALSE, include = FALSE}
# Clear environment
rm(list=ls())

# R Packages
if (!require('pacman')) install.packages('pacman'); library(pacman) 
p_load("devtools", "scales", "ellipse", "lazyeval", "igraph",  "ggraph", 
       "reshape2", "knitr", "stringr", "jsonlite", "rstudioapi", "tidyverse",
       "dampack", "data.table", "tornado", "ggplot2", "viridis",
       "kableExtra")                

```
***
```{r}
## Load model parameters
source("01_phase3_inputs.R")
l_params_all <- load_phase3_params()
v_names_str <- c("Status Quo", "Testing", "Vaccination", "Vaccination and Testing")
n_str <- length(v_names_str)

## Load model
source("02_phase3_functions.R")

```
***

```{r}
base_case_results  <- parvo_model(l_params_all)

base_case_results$Inc.Fetal.Deaths <- base_case_results[, 2] - base_case_results[1, 2]
base_case_results$Inc.Transfusions <- base_case_results[, 3] - base_case_results[1, 3]
base_case_results %>%
  kable() %>%
  kable_styling()

``` 


```{r, warning = FALSE}
### one way sensitivity analysis
# disable scientific notation
options(scipen = 999) 

# varying infection rate, and detection rate
df_params_owsa <- data.frame(pars = c("p_imm", "p_inf"),
                             # min parameter values
                             min  = c(0.25, 0.01), 
                             # max parameter values
                             max  = c(0.75, 0.20)
                             )
# OWSA
owsa_results <- run_owsa_det(params_range = df_params_owsa,  
                             # list of all params
                             params_basecase = l_params_all, 
                             # number of param values
                             nsamp      = 100, 
                             # function to compute outputs
                             FUN        = parvo_model, 
                             # outcomes
                             outcomes = c('Deaths', 'Transfusions'),
                             # names of the strategies
                             strategies = v_names_str,
                             progress = FALSE)
# # tornado plot
# # axis labels for tornado plots
# xa_cost <- c("Proportion Immune", "Infection Rate", "Detection Rate")
# 
# torn_cost <- owsa_tornado(owsa = owsa_cost$owsa_Deaths) +
#   labs(x="Varied Parameters", y = "Deaths")  +
#   scale_x_discrete(labels = xa_cost)
# torn_cost
# 
#  
# # tornado plot
# # axis labels for tornado plots
# xa_deaths <- c( "Detection Rate", "Proportion Immune", "Infection Rate")
# 
# torn_deaths <- owsa_tornado(owsa = owsa_deaths) + 
#   labs(x="Varied Parameters", y = "Deaths")  +
#   scale_x_discrete(labels = xa_deaths)
# torn_deaths
# 
# # owsa for transfusions
# owsa_transfusions <- run_owsa_det(params_range = df_params_owsa,  
#                          # list of all params
#                          params_basecase = l_params_all, 
#                          # number of param values
#                          nsamp      = 100, 
#                          # function to compute outputs
#                          FUN        = parvo_model, 
#                          # outcomes
#                          outcomes = c('Transfusions'),
#                          # names of the strategies
#                          strategies = v_names_str,
#                          progress = FALSE)   
# # tornado plot
# # axis labels for tornado plots
# xa_transfusions <- c( "Detection Rate", "Proportion Immune", "Infection Rate")
# 
# torn_transfusions <- owsa_tornado(owsa = owsa_transfusions) + 
#   labs(x="Varied Parameters", y = "Transfusions")  +
#   scale_x_discrete(labels = xa_transfusions)
# torn_transfusions

# One-way plots
owsa_results$owsa_Deaths <- owsa_results$owsa_Deaths %>%
  mutate(parameter = ifelse(parameter == "p_imm", "Proportion Immune",
                            ifelse(parameter == "p_inf", "Infection Rate",
                                   parameter)))
plot(owsa_results$owsa_Deaths) +
  ylab("Expected Deaths")


owsa_results$owsa_Transfusions <- owsa_results$owsa_Transfusions %>%
  mutate(parameter = ifelse(parameter == "p_imm", "Proportion Immune",
                            ifelse(parameter == "p_inf", "Infection Rate",
                                   parameter)))
plot(owsa_results$owsa_Transfusions) +
  ylab("Expected Fetal Transfusions")

```
***
```{r, warning = FALSE}
# two way sensitivity analysis of immunity and infection rate

df_params_twsa <- data.frame(pars = c("p_imm", "p_inf"),
                              # min parameter values
                              min  = c(0.25, 0.01), 
                              # max parameter values
                              max  = c(0.75, 0.20) 
                              )
# twsa dataframes for immunity and infection rate
twsa_results <- run_twsa_det(params_range = df_params_twsa, 
                             # list with all parameters
                             params_basecase = l_params_all,
                             # number of parameter values
                             nsamp      = 10,               
                             # function to compute outputs
                             FUN        = parvo_model, 
                             # outcomes
                             outcomes = c('Deaths', 'Transfusions'),
                             # names of the strategies
                             strategies = v_names_str,
                             progress = FALSE)


## heat maps status quo vs testing
twsa_deaths    <- twsa_results$twsa_Deaths %>%
  pivot_wider(names_from = strategy,
              values_from = outcome_val) %>%
  mutate(incremental = Status.Quo - Testing) %>%
  as.matrix()

heat_deaths_ii <- ggplot(data = twsa_deaths, mapping = aes(x = p_imm,
                                                  y = p_inf,
                                                  fill = incremental)) +
  geom_tile() +
  geom_text(aes(label = round(incremental, 0))) +
  xlab(label = 'Proportion Immune') +
  ylab(label = 'Infection Rate') +
  ggtitle("Deaths Averted: Status Quo vs. Routine Testing") +
  scale_fill_viridis(alpha = 0.75) +
  guides(fill=guide_legend(title="Deaths Averted")) +
  theme_bw() +
  theme(legend.position = "none")

heat_deaths_ii


twsa_transfusions <- twsa_results$twsa_Transfusions %>%
  pivot_wider(names_from = strategy,
              values_from = outcome_val) %>%
  mutate(incremental = Status.Quo - Testing) %>%
  as.matrix()

heat_transfusions_ii <- ggplot(data = twsa_transfusions, mapping = aes(x = p_imm,
                                                  y = p_inf,
                                                  fill = incremental)) +
  geom_tile() +
  geom_text(aes(label = round(incremental, 0))) +
  xlab(label = 'Proportion Immune') +
  ylab(label = 'Infection Rate') +
  ggtitle("Transfusions Averted: Status Quo vs. Routine Testing") +
  scale_fill_viridis(alpha = 0.75) +
  guides(fill=guide_legend(title="Transfusions Averted")) +
  theme_bw() +
  theme(legend.position = "none")

heat_transfusions_ii

## heat maps status quo vs vaccination
twsa_deaths    <- twsa_results$twsa_Deaths %>%
  pivot_wider(names_from = strategy,
              values_from = outcome_val) %>%
  mutate(incremental = Status.Quo - Vaccination) %>%
  as.matrix()

heat_deaths_ii <- ggplot(data = twsa_deaths, mapping = aes(x = p_imm,
                                                  y = p_inf,
                                                  fill = incremental)) +
  geom_tile() +
  geom_text(aes(label = round(incremental, 0))) +
  xlab(label = 'Proportion Immune') +
  ylab(label = 'Infection Rate') +
  ggtitle("Deaths Averted: Status Quo vs. Vaccination") +
  scale_fill_viridis(alpha = 0.75) +
  guides(fill=guide_legend(title="Deaths Averted")) +
  theme_bw() +
  theme(legend.position = "none")

heat_deaths_ii


twsa_transfusions <- twsa_results$twsa_Transfusions %>%
  pivot_wider(names_from = strategy,
              values_from = outcome_val) %>%
  mutate(incremental = Status.Quo - Vaccination) %>%
  as.matrix()

heat_transfusions_ii <- ggplot(data = twsa_transfusions, mapping = aes(x = p_imm,
                                                  y = p_inf,
                                                  fill = incremental)) +
  geom_tile() +
  geom_text(aes(label = round(incremental, 0))) +
  xlab(label = 'Proportion Immune') +
  ylab(label = 'Infection Rate') +
  ggtitle("Transfusions Averted: Status Quo vs. Vaccination") +
  scale_fill_viridis(alpha = 0.75) +
  guides(fill=guide_legend(title="Transfusions Averted")) +
  theme_bw() +
  theme(legend.position = "none")

heat_transfusions_ii


## heat maps status quo vs vaccination + testing
twsa_deaths    <- twsa_results$twsa_Deaths %>%
  pivot_wider(names_from = strategy,
              values_from = outcome_val) %>%
  mutate(incremental = Status.Quo - Vaccination.and.Testing) %>%
  as.matrix()

heat_deaths_ii <- ggplot(data = twsa_deaths, mapping = aes(x = p_imm,
                                                  y = p_inf,
                                                  fill = incremental)) +
  geom_tile() +
  geom_text(aes(label = round(incremental, 0))) +
  xlab(label = 'Proportion Immune') +
  ylab(label = 'Infection Rate') +
  ggtitle("Deaths Averted: Status Quo vs. Vaccination + Testing") +
  scale_fill_viridis(alpha = 0.75) +
  guides(fill=guide_legend(title="Deaths Averted")) +
  theme_bw() +
  theme(legend.position = "none")

heat_deaths_ii


twsa_transfusions <- twsa_results$twsa_Transfusions %>%
  pivot_wider(names_from = strategy,
              values_from = outcome_val) %>%
  mutate(incremental = Status.Quo - Vaccination.and.Testing) %>%
  as.matrix()

heat_transfusions_ii <- ggplot(data = twsa_transfusions, mapping = aes(x = p_imm,
                                                  y = p_inf,
                                                  fill = incremental)) +
  geom_tile() +
  geom_text(aes(label = round(incremental, 0))) +
  xlab(label = 'Proportion Immune') +
  ylab(label = 'Infection Rate') +
  ggtitle("Transfusions Averted: Status Quo vs. Vaccination + Testing") +
  scale_fill_viridis(alpha = 0.75) +
  guides(fill=guide_legend(title="Transfusions Averted")) +
  theme_bw() +
  theme(legend.position = "none")

heat_transfusions_ii

```
***
```{r, warning = FALSE}
# two way sensitivity analysis of immunity and detection rate

df_params_twsa <- data.frame(pars = c("p_imm", "p_det_surv"),
                              # min parameter values
                              min  = c(0.25, 0.1), 
                              # max parameter values
                              max  = c(0.75, 0.9) 
                              )
# twsa dataframes for immunity and detection rate
twsa_cost <- run_twsa_det(params_range = df_params_twsa, 
                         # list with all parameters
                         params_basecase = l_params_all,
                         # number of parameter values
                         nsamp      = 40,               
                         # function to compute outputs
                         FUN        = sa, 
                         # outcomes
                         outcomes = c('Cost'),
                         # names of the strategies
                         strategies = v_names_str,
                         progress = FALSE)

twsa_deaths <- run_twsa_det(params_range = df_params_twsa, 
                         # list with all parameters
                         params_basecase = l_params_all,
                         # number of parameter values
                         nsamp      = 40,               
                         # function to compute outputs
                         FUN        = sa, 
                         # outcomes
                         outcomes = c('Deaths'),
                         # names of the strategies
                         strategies = v_names_str,
                         progress = FALSE)

twsa_transfusions <- run_twsa_det(params_range = df_params_twsa, 
                         # list with all parameters
                         params_basecase = l_params_all,
                         # number of parameter values
                         nsamp      = 40,               
                         # function to compute outputs
                         FUN        = sa, 
                         # outcomes
                         outcomes = c('Transfusions'),
                         # names of the strategies
                         strategies = v_names_str,
                         progress = FALSE)


# heat maps
twsa_cost <- data.matrix(twsa_cost)
heat_cost_id <- ggplot(data = twsa_cost, mapping = aes(x = p_imm,
                                                  y = p_det_surv,
                                                  fill = outcome_val)) +
  geom_tile() +
  xlab(label = 'Proportion Immune') +
  ylab(label = 'Detection Rate') +
  scale_fill_viridis() +
  guides(fill=guide_legend(title="Costs"))

heat_cost_id

twsa_deaths <- data.matrix(twsa_deaths)
heat_deaths_id <- ggplot(data = twsa_deaths, mapping = aes(x = p_imm,
                                                  y = p_det_surv,
                                                  fill = outcome_val)) +
  geom_tile() +
  xlab(label = 'Proportion Immune') +
  ylab(label = 'Detection Rate') +
  scale_fill_viridis() +
  guides(fill=guide_legend(title="Deaths"))

heat_deaths_id

twsa_transfusions <- data.matrix(twsa_transfusions)
heat_transfusions_id <- ggplot(data = twsa_transfusions, mapping = aes(x = p_imm,
                                                  y = p_det_surv,
                                                  fill = outcome_val)) +
  geom_tile() +
  xlab(label = 'Proportion Immune') +
  ylab(label = 'Detection Rate') +
  scale_fill_viridis() +
  guides(fill=guide_legend(title="Transfusions"))

heat_transfusions_id

```
***
```{r, warning = FALSE}
# two way sensitivity analysis of detection rate and infection rate

df_params_twsa <- data.frame(pars = c("p_det_surv", "p_inf"),
                              # min parameter values
                              min  = c(0.1, 0.01), 
                              # max parameter values
                              max  = c(0.9, 0.20) 
                              )
# twsa dataframes for detection rate and infection rate
twsa_cost <- run_twsa_det(params_range = df_params_twsa, 
                         # list with all parameters
                         params_basecase = l_params_all,
                         # number of parameter values
                         nsamp      = 40,               
                         # function to compute outputs
                         FUN        = sa, 
                         # outcomes
                         outcomes = c('Cost'),
                         # names of the strategies
                         strategies = v_names_str,
                         progress = FALSE)

twsa_deaths <- run_twsa_det(params_range = df_params_twsa, 
                         # list with all parameters
                         params_basecase = l_params_all,
                         # number of parameter values
                         nsamp      = 40,               
                         # function to compute outputs
                         FUN        = sa, 
                         # outcomes
                         outcomes = c('Deaths'),
                         # names of the strategies
                         strategies = v_names_str,
                         progress = FALSE)

twsa_transfusions <- run_twsa_det(params_range = df_params_twsa, 
                         # list with all parameters
                         params_basecase = l_params_all,
                         # number of parameter values
                         nsamp      = 40,               
                         # function to compute outputs
                         FUN        = sa, 
                         # outcomes
                         outcomes = c('Transfusions'),
                         # names of the strategies
                         strategies = v_names_str,
                         progress = FALSE)


# heat maps
# heat maps
twsa_cost <- data.matrix(twsa_cost)
heat_cost_di <- ggplot(data = twsa_cost, mapping = aes(x = p_det_surv,
                                                  y = p_inf,
                                                  fill = outcome_val)) +
  geom_tile() +
  xlab(label = 'Detection Rate') +
  ylab(label = 'Infection Rate') +
  scale_fill_viridis() +
  guides(fill=guide_legend(title="Costs"))

heat_cost_di

twsa_deaths <- data.matrix(twsa_deaths)
heat_deaths_di <- ggplot(data = twsa_deaths, mapping = aes(x = p_det_surv,
                                                  y = p_inf,
                                                  fill = outcome_val)) +
  geom_tile() +
  xlab(label = 'Detection Rate') +
  ylab(label = 'Infection Rate') +
  scale_fill_viridis() +
  guides(fill=guide_legend(title="Deaths"))

heat_deaths_di

twsa_transfusions <- data.matrix(twsa_transfusions)
heat_transfusions_di <- ggplot(data = twsa_transfusions, mapping = aes(x = p_det_surv,
                                                  y = p_inf,
                                                  fill = outcome_val)) +
  geom_tile() +
  xlab(label = 'Detection Rate') +
  ylab(label = 'Infection Rate') +
  scale_fill_viridis() +
  guides(fill=guide_legend(title="Transfusions"))

heat_transfusions_di
```
***
